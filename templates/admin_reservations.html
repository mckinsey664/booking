{% extends "admin_dashboard.html" %}
{% block content %}
<div class="container-fluid">

  <!-- üóì Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 text-white fw-semibold">üóì All Reservations</h2>
    <button class="btn btn-brand text-white fw-semibold" data-bs-toggle="modal" data-bs-target="#addReservationModal">
      + Add Reservation
    </button>
  </div>

  <!-- üßæ Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} text-center mb-3 py-2">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- üîç FRONTEND FILTERS -->
<div class="row g-3 mb-4">

  <!-- Filter by Date -->
  <div class="col-md-3">
    <label class="form-label text-white-50">Filter by Date</label>
    <select id="filterDate" class="form-select bg-dark text-white border-secondary">
      <option value="">All Dates</option>
      <option value="2025-12-09">December 9, 2025</option>
      <option value="2025-12-10">December 10, 2025</option>
    </select>
  </div>

  <!-- Filter by Room -->
  <div class="col-md-3">
    <label class="form-label text-white-50">Filter by Room</label>
    <select id="filterRoom" class="form-select bg-dark text-white border-secondary">
      <option value="">All Rooms</option>
      <option value="Sofitel The Obelisk - Al Neel 1">Sofitel The Obelisk - Al Neel 1</option>
      <option value="Sofitel The Obelisk - Al Neel 2">Sofitel The Obelisk - Al Neel 2</option>
    </select>
  </div>

</div>


  <!-- üìã Reservations Table -->
  {% if reservations %}
  <div class="card bg-dark border-0 shadow-sm p-3 rounded-3">
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead style="background-color: #CF6000;">
          <tr class="text-white text-center">
            <th>Meeting Date</th>
            <th>Meeting Time</th>
            <th>Room Nb</th>
            <th>Requester Name</th>
            <th>Invitee Name</th>
            <th>Status</th>
            <th>Delete</th>
          </tr>
        </thead>

        <tbody>
          {% for r in reservations %}
          <tr class="align-middle text-center">

            <!-- üìÖ DATE -->
            <td class="text-white fw-semibold">{{ r['date'] }}</td>

            <!-- ‚è∞ TIME -->
            <td>
              <span class="badge bg-secondary fs-6 px-3 py-2">{{ r['start_time'] }}</span>
            </td>

            <!-- üè† ROOM -->
            <td>
              <span class="badge bg-brand text-white fs-6 px-3 py-2">{{ r['room_name'] }}</span>
            </td>

            <!-- üë§ REQUESTER -->
            <td class="text-white">
              {{ r['booker_name'] }}
            </td>

            <!-- üë§ INVITEE -->
            <td class="text-white">
              {{ r['entity_name'] }}
            </td>

            <!-- üîµ STATUS -->
            <td>
              {% if r['status'] == 'Approved' %}
  <span class="badge bg-success px-3 py-2">Confirmed</span>

{% elif r['status'] == 'Rejected' %}
  <span class="badge bg-danger px-3 py-2">Declined</span>

{% elif r['status'] == 'Done' %}
  <span class="badge bg-info text-dark px-3 py-2">Done</span>

{% else %}
  <span class="badge bg-warning text-dark px-3 py-2">Pending</span>
{% endif %}

            </td>

            <!-- üóë DELETE -->
            <td>
              <form action="{{ url_for('delete_reservation', reservation_id=r['id']) }}" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-danger btn-sm px-3"
                        onclick="return confirm('Are you sure you want to delete this reservation?');">
                  üóë
                </button>
              </form>
              <form action="{{ url_for('mark_done', reservation_id=r['id']) }}" method="post" class="d-inline">
                <button class="btn btn-outline-info btn-sm px-3"
                onclick="return confirm('Mark this reservation as done?');">
                ‚úî
                </button>
              </form>

            </td>

          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

  {% else %}
    <div class="alert alert-secondary text-center mt-3 py-3">
      <strong>No reservations found.</strong>
    </div>
  {% endif %}
</div>
<!-- üüß Add Reservation Modal -->
<div class="modal fade" id="addReservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white border-0">

      <div class="modal-header border-0">
        <h5 class="modal-title">Add New Reservation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form method="POST" action="{{ url_for('admin_add_reservation') }}">

          <div class="row g-3">

            <!-- DATE -->
            <div class="col-md-6">
              <label class="form-label text-white-50">Date</label>
              <select name="date" class="form-select bg-dark text-white border-secondary" required>
                <option value="">Select Date</option>
                <option value="2025-12-09">December 9, 2025</option>
                <option value="2025-12-10">December 10, 2025</option>
              </select>
            </div>

            <!-- START TIME -->
<div class="col-md-6">
  <label class="form-label text-white-50">Start Time</label>
  <select name="start_time" class="form-select bg-dark text-white border-secondary" required>
      <option value="">Select Time Slot</option>

      <option value="09:00">09:00 - 09:20</option>
      <option value="09:20">09:20 - 09:40</option>
      <option value="09:40">09:40 - 10:00</option>

      <option value="10:00">10:00 - 10:20</option>
      <option value="10:20">10:20 - 10:40</option>
      <option value="10:40">10:40 - 11:00</option>

      <option value="11:00">11:00 - 11:20</option>
      <option value="11:20">11:20 - 11:40</option>
      <option value="11:40">11:40 - 12:00</option>

      <option value="12:00">12:00 - 12:20</option>
      <option value="12:20">12:20 - 12:40</option>
      <option value="12:40">12:40 - 13:00</option>

      <option value="13:00">13:00 - 13:20</option>
      <option value="13:20">13:20 - 13:40</option>
      <option value="13:40">13:40 - 14:00</option>

      <option value="14:00">14:00 - 14:20</option>
      <option value="14:20">14:20 - 14:40</option>
      <option value="14:40">14:40 - 15:00</option>

      <option value="15:00">15:00 - 15:20</option>
      <option value="15:20">15:20 - 15:40</option>
      <option value="15:40">15:40 - 16:00</option>

      <option value="16:00">16:00 - 16:20</option>
      <option value="16:20">16:20 - 16:40</option>
      <option value="16:40">16:40 - 17:00</option>
  </select>
</div>



            <!-- ROOM -->
            <div class="col-md-6">
              <label class="form-label text-white-50">Room</label>
              <select name="room_name" class="form-select bg-dark text-white border-secondary" required>
                <option value="">Select Room</option>
                {% for room in rooms %}
                  <option value="{{ room['name'] }}">{{ room['name'] }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- REQUESTER (SEARCH) -->
            <div class="col-md-6 position-relative">
              <label class="form-label text-white-50">Requester</label>
              <input type="text" id="requesterSearch" class="form-control bg-dark text-white border-secondary"
                     placeholder="Search requester..." autocomplete="off">
              <div id="requesterResults" class="search-dropdown"></div>
              <input type="hidden" name="requester_id" id="requesterId">
            </div>

            <!-- INVITEE (SEARCH) -->
            <div class="col-md-6 position-relative">
              <label class="form-label text-white-50">Invitee</label>
              <input type="text" id="inviteeSearch" class="form-control bg-dark text-white border-secondary"
                     placeholder="Search invitee..." autocomplete="off">
              <div id="inviteeResults" class="search-dropdown"></div>
              <input type="hidden" name="invitee_id" id="inviteeId">
            </div>

          </div>

          <div class="mt-4 text-end">
            <button class="btn btn-brand text-white px-4">Save Reservation</button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>

<style>
  /* Make modal content the stacking root */
.modal-content {
  position: relative !important;
  z-index: 3000 !important;
}

/* Ensure search dropdown appears on top */
.search-dropdown {
  position: absolute;
  background: #222;
  border: 1px solid #444;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  z-index: 4000 !important;   /* ‚Üê higher than modal */
  border-radius: 5px;
}

.search-dropdown div {
  padding: 8px;
  cursor: pointer;
  color: #fff;
}
.search-dropdown div:hover {
  background: #444;
}
</style>


<!-- üé® Custom Styling -->
<style>
  .btn-brand {
    background-color: #CF6000;
    border: none;
    transition: 0.3s;
  }
  .btn-brand:hover {
    background-color: #b85100;
  }
  .bg-brand { background-color: #CF6000 !important; }
  .table-hover tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
  .badge { border-radius: 8px; }
  .alert-secondary {
    background-color: #2b2b2b;
    border: none;
    color: #d0d0d0;
    border-radius: 6px;
  }
  .form-control, .form-select {
    border-radius: 6px;
  }
</style>

<!-- üß© Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

  const dateFilter = document.getElementById("filterDate");
  const roomFilter = document.getElementById("filterRoom");
  const rows = document.querySelectorAll("table tbody tr");

  function applyFilters() {
    const selectedDate = dateFilter.value;
    const selectedRoom = roomFilter.value;

    rows.forEach(row => {
      const rowDate = row.children[0].innerText.trim();
      const rowRoom = row.children[2].innerText.trim();  // Room column

      const matchesDate = !selectedDate || rowDate === selectedDate;
      const matchesRoom = !selectedRoom || rowRoom.includes(selectedRoom);

      if (matchesDate && matchesRoom) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }

  dateFilter.addEventListener("change", applyFilters);
  roomFilter.addEventListener("change", applyFilters);

});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {

    function setupSearch(inputId, resultsId, hiddenFieldId) {
        const input = document.getElementById(inputId);
        const results = document.getElementById(resultsId);

        if (!input) {
            console.log("‚ùå ERROR: Input field " + inputId + " not found.");
            return;
        }

        input.addEventListener("input", function () {
            const q = input.value.trim();
            if (!q) {
                results.innerHTML = "";
                return;
            }

            fetch("/search_entities?q=" + encodeURIComponent(q))
                .then(response => response.json())
                .then(data => {
                    results.innerHTML = "";
                    data.forEach(item => {
                        if (item.type === "person") {
                            const div = document.createElement("div");
                            div.textContent = item.label;
                            div.classList.add("dropdown-item-result");
                            div.onclick = () => {
                                input.value = item.label;
                                document.getElementById(hiddenFieldId).value = item.id;
                                results.innerHTML = "";
                            };
                            results.appendChild(div);
                        }
                    });
                })
                .catch(err => console.error("Fetch error:", err));
        });
    }

    setupSearch("requesterSearch", "requesterResults", "requesterId");
    setupSearch("inviteeSearch", "inviteeResults", "inviteeId");

});
</script>

<style>
.dropdown-item-result {
  padding: 8px;
  color: white;
  cursor: pointer;
}
.dropdown-item-result:hover {
  background: #444;
}
</style>


{% endblock %}
